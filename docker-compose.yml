version: '3.8'

# .env 파일에 환경 변수가 등록되어 있어야 합니다. 환경변수 항목 등은 논의가 필요해 보입니다.

services:
  db:
    # MySQL 8.4.5 (LTS) 최신 버전 사용
    image: mysql:8.4.5

    # 컨테이너 이름 지정 (docker ps에서 확인 용도)
    container_name: rarego-mysql

    # 비정상 종료 시 자동 재시작
    restart: always

    # 포트 매핑 (호스트 포트 : 3306)
    # .env 파일의 DB_PORT 변수를 사용하여 로컬 포트 충돌 방지
    ports:
      - "${DB_PORT:-3306}:3306"

    # 환경변수 설정 (.env 파일 참조)
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD} # 루트 비밀번호
      MYSQL_DATABASE: ${DB_NAME} # 초기 생성할 DB 이름
      MYSQL_USER: ${DB_USERNAME} # 사용할 유저 아이디
      MYSQL_PASSWORD: ${DB_PASSWORD} # 사용할 유저 비밀번호
      TZ: ${TZ:-Asia/Seoul} # 로그 시간 확인용 타임존 (한국)

    # 한글/이모지 깨짐 방지 설정 (utf8mb4)
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci

    # 데이터 영속성 설정 (컨테이너 삭제돼도 데이터 보존)
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - rarego-network

    # 컨테이너 상태 체크 (Spring Boot의 depends_on 조건 등으로 활용 가능)
    # DB가 완전히 부팅되어 쿼리를 받을 수 있는지 주기적으로 확인
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  app:
    image: ${DOCKER_IMAGE:-rarego-app:latest}
    container_name: rarego-app
    ports:
      - "8080:8080"
    environment:
      # DB 연결 정보 (서비스 이름 'db' 사용)
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/${DB_NAME}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul
      SPRING_DATASOURCE_USERNAME: ${DB_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD}

      # 애플리케이션 환경 변수
      TOSS_PAYMENTS_SECRET_KEY: ${TOSS_PAYMENTS_SECRET_KEY}
      JWT_SECRET: ${JWT_SECRET:-dev-secret-key-have-to-change-abcdefghijklmnopqrstuvwxyz1234567890abcdefghijklmnopqrstuvwxyz}
      AWS_ACCESS_KEY: ${AWS_ACCESS_KEY}
      AWS_SECRET_KEY: ${AWS_SECRET_KEY}
      INTERNAL_BACK_URL: ${INTERNAL_BACK_URL:-http://localhost:8080}
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-dev}
      TZ: Asia/Seoul

      # Infra endpoints
      SPRING_DATA_REDIS_HOST: ${REDIS_HOST:-redis}
      SPRING_DATA_REDIS_PORT: ${REDIS_PORT:-6379}
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-kafka:9092}
      SPRING_ELASTICSEARCH_URIS: ${ELASTICSEARCH_URIS:-http://elasticsearch:9200}

      # Social Login (OAuth2)
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET: ${GOOGLE_SECRET}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_KAKAO_CLIENT_ID: ${KAKAO_CLIENT}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_NAVER_CLIENT_ID: ${NAVER_CLIENT}
      SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_NAVER_CLIENT_SECRET: ${NAVER_SECRET}
    depends_on:
      db:
        condition: service_healthy
    restart: always
    networks:
      - rarego-network

  redis:
    image: redis:7.2
    container_name: rarego-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    restart: always
    networks:
      - rarego-network

  zookeeper:
    image: confluentinc/cp-zookeeper:7.7.7
    container_name: rarego-zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    restart: always
    networks:
      - rarego-network

  kafka:
    image: confluentinc/cp-kafka:7.7.7
    container_name: rarego-kafka
    ports:
      - "${KAFKA_HOST_PORT:-29092}:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    depends_on:
      - zookeeper
    restart: always
    networks:
      - rarego-network

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.4
    container_name: rarego-elasticsearch
    ports:
      - "${ELASTICSEARCH_PORT:-9200}:9200"
    environment:
      discovery.type: single-node
      xpack.security.enabled: "false"
      ES_JAVA_OPTS: "-Xms512m -Xmx512m"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    restart: always
    networks:
      - rarego-network

  prometheus:
    image: prom/prometheus:v2.52.0
    container_name: rarego-prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    restart: always
    networks:
      - rarego-network

  grafana:
    image: grafana/grafana:10.4.3
    container_name: rarego-grafana
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
    volumes:
      - grafana_data:/var/lib/grafana
    restart: always
    networks:
      - rarego-network

# 도커 볼륨 생성 (최상위 레벨 정의)
volumes:
  db_data:
  redis_data:
  es_data:
  prometheus_data:
  grafana_data:


networks:
  rarego-network:
    name: rarego-network
